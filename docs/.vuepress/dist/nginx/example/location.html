<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.25">
    <title>[转] nginx 配置 location 总结及 rewrite 规则写法 | 笔记@小有记</title><meta name="description" content="">
    <link rel="preload" href="/assets/js/runtime~app.ce6e78a5.js" as="script"><link rel="preload" href="/assets/css/styles.c2dbe51e.css" as="style"><link rel="preload" href="/assets/js/2968.6fb6be6b.js" as="script"><link rel="preload" href="/assets/js/app.21ffca0f.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.c2dbe51e.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container no-sidebar"><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><img class="logo" src="/images/logo.png" alt="笔记@小有记"><span class="site-name can-hide">笔记@小有记</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/ops/" class="nav-link" aria-label="运维"><!--[--><!--]--> 运维 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/os/" class="nav-link" aria-label="系统"><!--[--><!--]--> 系统 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/nginx/" class="nav-link router-link-active" aria-label="Nginx"><!--[--><!--]--> Nginx <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/mysql/" class="nav-link" aria-label="Mysql"><!--[--><!--]--> Mysql <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/javascript/" class="nav-link" aria-label="前端"><!--[--><!--]--> 前端 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/ops/" class="nav-link" aria-label="运维"><!--[--><!--]--> 运维 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/os/" class="nav-link" aria-label="系统"><!--[--><!--]--> 系统 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/nginx/" class="nav-link router-link-active" aria-label="Nginx"><!--[--><!--]--> Nginx <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/mysql/" class="nav-link" aria-label="Mysql"><!--[--><!--]--> Mysql <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/javascript/" class="nav-link" aria-label="前端"><!--[--><!--]--> 前端 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--]--></ul><!--[--><!--]--></aside><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="转-nginx-配置-location-总结及-rewrite-规则写法" tabindex="-1"><a class="header-anchor" href="#转-nginx-配置-location-总结及-rewrite-规则写法" aria-hidden="true">#</a> [转] nginx 配置 location 总结及 rewrite 规则写法</h1><h2 id="_1-location正则写法" tabindex="-1"><a class="header-anchor" href="#_1-location正则写法" aria-hidden="true">#</a> 1. location正则写法</h2><p>一个示例：</p><div class="language-nginx ext-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span>  = /</span> <span class="token punctuation">{</span>
  <span class="token comment"># 精确匹配 / ，主机名后面不能带任何字符串</span>
  [ configuration A ]
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span>  /</span> <span class="token punctuation">{</span>
  <span class="token comment"># 因为所有的地址都以 / 开头，所以这条规则将匹配到所有请求</span>
  <span class="token comment"># 但是正则和最长字符串会优先匹配</span>
  [ configuration B ]
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> /documents/</span> <span class="token punctuation">{</span>
  <span class="token comment"># 匹配任何以 /documents/ 开头的地址，匹配符合以后，还要继续往下搜索</span>
  <span class="token comment"># 只有后面的正则表达式没有匹配到时，这一条才会采用这一条</span>
  [ configuration C ]
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> ~ /documents/Abc</span> <span class="token punctuation">{</span>
  <span class="token comment"># 匹配任何以 /documents/Abc 开头的地址，匹配符合以后，还要继续往下搜索</span>
  <span class="token comment"># 只有后面的正则表达式没有匹配到时，这一条才会采用这一条</span>
  [ configuration CC ]
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> ^~ /images/</span> <span class="token punctuation">{</span>
  <span class="token comment"># 匹配任何以 /images/ 开头的地址，匹配符合以后，停止往下搜索正则，采用这一条。</span>
  [ configuration D ]
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> ~* \.(gif|jpg|jpeg)$</span> <span class="token punctuation">{</span>
  <span class="token comment"># 匹配所有以 gif,jpg或jpeg 结尾的请求</span>
  <span class="token comment"># 然而，所有请求 /images/ 下的图片会被 config D 处理，因为 ^~ 到达不了这一条正则</span>
  [ configuration E ]
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> /images/</span> <span class="token punctuation">{</span>
  <span class="token comment"># 字符匹配到 /images/，继续往下，会发现 ^~ 存在</span>
  [ configuration F ]
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> /images/abc</span> <span class="token punctuation">{</span>
  <span class="token comment"># 最长字符匹配到 /images/abc，继续往下，会发现 ^~ 存在</span>
  <span class="token comment"># F与G的放置顺序是没有关系的</span>
  [ configuration G ]
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">location</span> ~ /images/abc/</span> <span class="token punctuation">{</span>
  <span class="token comment"># 只有去掉 config D 才有效：先最长匹配 config G 开头的地址，继续往下搜索，匹配到这一条正则，采用</span>
    [ configuration H ]
<span class="token punctuation">}</span>

location ~* /js/.*/\.js
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><ul><li>以 <code>=</code> 开头表示精确匹配 如 A 中只匹配根目录结尾的请求，后面不能带任何字符串。</li><li><code>^~</code> 开头表示uri以某个常规字符串开头，不是正则匹配</li><li><code>~</code> 开头表示区分大小写的正则匹配;</li><li><code>~*</code> 开头表示不区分大小写的正则匹配</li><li><code>/</code> 通用匹配, 如果没有其它匹配,任何请求都会匹配到</li></ul><p>顺序 no优先级： (location =) &gt; (location 完整路径) &gt; (location ^~ 路径) &gt; (location ~,~* 正则顺序) &gt; (location 部分起始路径) &gt; (/)</p><p>上面的匹配结果 按照上面的location写法，以下的匹配示例成立：</p><ul><li>/ -&gt; config A 精确完全匹配，即使/index.html也匹配不了</li><li>/downloads/download.html -&gt; config B 匹配B以后，往下没有任何匹配，采用B</li><li>/images/1.gif -&gt; configuration D 匹配到F，往下匹配到D，停止往下</li><li>/images/abc/def -&gt; config D 最长匹配到G，往下匹配D，停止往下 你可以看到 任何以/images/开头的都会匹配到D并停止，FG写在这里是没有任何意义的，H是永远轮不到的，这里只是为了说明匹配顺序</li><li>/documents/document.html -&gt; config C 匹配到C，往下没有任何匹配，采用C</li><li>/documents/1.jpg -&gt; configuration E 匹配到C，往下正则匹配到E</li><li>/documents/Abc.jpg -&gt; config CC 最长匹配到C，往下正则顺序匹配到CC，不会往下到E</li></ul><h3 id="实际使用建议" tabindex="-1"><a class="header-anchor" href="#实际使用建议" aria-hidden="true">#</a> 实际使用建议</h3><p>所以实际使用中，个人觉得至少有三个匹配规则定义，如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>#直接匹配网站根，通过域名访问网站首页比较频繁，使用这个会加速处理，官网如是说。
#这里是直接转发给后端应用服务器了，也可以是一个静态首页
# 第一个必选规则
location = / {
    proxy_pass [http://tomcat](http://tomcat/):8080/index
}

# 第二个必选规则是处理静态文件请求，这是nginx作为http服务器的强项
# 有两种配置模式，目录匹配或后缀匹配,任选其一或搭配使用
location ^~ /static/ {
    root /webroot/static/;
}

location ~* \.(gif|jpg|jpeg|png|css|js|ico)$ {
    root /webroot/res/;
}

#第三个规则就是通用规则，用来转发动态请求到后端应用服务器
#非静态文件请求就默认是动态请求，自己根据实际把握
#毕竟目前的一些框架的流行，带.php,.jsp后缀的情况很少了
location / {
    proxy_pass [http://tomcat](http://tomcat/):8080/
}
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><a href="http://tengine.taobao.org/book/chapter_02.html" target="_blank" rel="noopener noreferrer">http://tengine.taobao.org/book/chapter_02.html<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a><a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html" target="_blank" rel="noopener noreferrer">http://nginx.org/en/docs/http/ngx_http_rewrite_module.html<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p><h2 id="_2-rewrite规则" tabindex="-1"><a class="header-anchor" href="#_2-rewrite规则" aria-hidden="true">#</a> 2. Rewrite规则</h2><p>rewrite 功能就是，使用 nginx 提供的全局变量或自己设置的变量，结合正则表达式和标志位实现url重写以及重定向。rewrite 只能放在<code>server{}</code>, <code>location{}</code>, <code>if{}</code> 中，并且只能对域名后边的除去传递的参数外的字符串起作用，例如 <code>http://seanlook.com/a/we/index.php?id=1&amp;u=str</code> 只对/a/we/index.php重写。语法<code>rewrite regex replacement [flag];</code></p><p>如果相对域名或参数字符串起作用，可以使用全局变量匹配，也可以使用 proxy_pass 反向代理。</p><p>表面看 <code>rewrite</code> 和 <code>location</code> 功能有点像，都能实现跳转，主要区别在于 rewrite 是在同一域名内更改获取资源的路径，而 location 是对一类路径做控制访问或反向代理，可以 <code>proxy_pass</code> 到其他机器。很多情况下 rewrite 也会写在 location 里，它们的执行顺序是：</p><ol><li>执行 server 块的 rewrite 指令</li><li>执行 location 匹配</li><li>执行选定的 location 中的 rewrite 指令</li></ol><p>如果其中某步URI被重写，则重新循环执行1-3，直到找到真实存在的文件；循环超过10次，则返回500 Internal Server Error错误。</p><h3 id="_2-1-flag标志位" tabindex="-1"><a class="header-anchor" href="#_2-1-flag标志位" aria-hidden="true">#</a> 2.1 flag标志位</h3><ul><li><code>last</code> : 相当于Apache的[L]标记，表示完成rewrite</li><li><code>break</code> : 停止执行当前虚拟主机的后续rewrite指令集</li><li><code>redirect</code> : 返回302临时重定向，地址栏会显示跳转后的地址</li><li><code>permanent</code> : 返回301永久重定向，地址栏会显示跳转后的地址</li></ul><p>因为301和302不能简单的只返回状态码，还必须有重定向的URL，这就是return指令无法返回301,302的原因了。这里 last 和 break 区别有点难以理解：</p><ol><li>last一般写在server和if中，而break一般使用在location中</li><li>last不终止<em>重写后</em>的url匹配，即新的url会再从server走一遍匹配流程，而break终止重写后的匹配</li><li>break和last都能组织继续执行后面的rewrite指令</li></ol><h3 id="_2-2-if指令与全局变量" tabindex="-1"><a class="header-anchor" href="#_2-2-if指令与全局变量" aria-hidden="true">#</a> 2.2 if指令与全局变量</h3><p><strong>if判断指令</strong> 语法为<code>if(condition){...}</code>，对给定的条件condition进行判断。如果为真，大括号内的rewrite指令将被执行，if条件(conditon)可以是如下任何内容：</p><ul><li>当表达式只是一个变量时，如果值为空或任何以0开头的字符串都会当做false</li><li>直接比较变量和内容时，使用<code>=</code>或<code>!=</code></li><li><code>~</code>正则表达式匹配，<code>~*</code>不区分大小写的匹配，<code>!~</code>区分大小写的不匹配</li></ul><p><code>-f</code>和<code>!-f</code>用来判断是否存在文件 <code>-d</code>和<code>!-d</code>用来判断是否存在目录 <code>-e</code>和<code>!-e</code>用来判断是否存在文件或目录 <code>-x</code>和<code>!-x</code>用来判断文件是否可执行</p><p>例如：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>
if ($http_user_agent ~ MSIE) {
    rewrite ^(.*)$ /msie/$1 break;
} //如果UA包含&quot;MSIE&quot;，rewrite请求到/msid/目录下

if ($http_cookie ~* &quot;id=([^;]+)(?:;|$)&quot;) {
    set $id $1;
 } //如果cookie匹配正则，设置变量$id等于正则引用部分

if ($request_method = POST) {
    return 405;
} //如果提交方法为POST，则返回状态405（Method not allowed）。return不能返回301,302

if ($slow) {
    limit_rate 10k;
} //限速，$slow可以通过 set 指令设置

if (!-f $request_filename){
    break;
    proxy_pass  http://127.0.0.1;
} //如果请求的文件名不存在，则反向代理到localhost 。这里的break也是停止rewrite检查

if ($args ~ post=140){
    rewrite ^ http://[example.com/](http://example.com/) permanent;
} //如果query string中包含&quot;post=140&quot;，永久重定向到example.com

location ~* \.(gif|jpg|png|swf|flv)$ {
    valid_referers none blocked [www.jefflei.com](http://www.jefflei.com/) [www.leizhenfang.com](http://www.leizhenfang.com/);
    if ($invalid_referer) {
        return 404;
    } //防盗链
}
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p><strong>全局变量</strong> 下面是可以用作if判断的全局变量</p><ul><li><code>$args</code> ： #这个变量等于请求行中的参数，同<code>$query_string</code></li><li><code>$content_length</code> ： 请求头中的Content-length字段。</li><li><code>$content_type</code> ： 请求头中的Content-Type字段。</li><li><code>$document_root</code> ： 当前请求在root指令中指定的值。</li><li><code>$host</code> ： 请求主机头字段，否则为服务器名称。</li><li><code>$http_user_agent</code> ： 客户端agent信息</li><li><code>$http_cookie</code> ： 客户端cookie信息</li><li><code>$limit_rate</code> ： 这个变量可以限制连接速率。</li><li><code>$request_method</code> ： 客户端请求的动作，通常为GET或POST。</li><li><code>$remote_addr</code> ： 客户端的IP地址。</li><li><code>$remote_port</code> ： 客户端的端口。</li><li><code>$remote_user</code> ： 已经经过Auth Basic Module验证的用户名。</li><li><code>$request_filename</code> ： 当前请求的文件路径，由root或alias指令与URI请求生成。</li><li><code>$scheme</code> ： HTTP方法（如http，https）。</li><li><code>$server_protocol</code> ： 请求使用的协议，通常是HTTP/1.0或HTTP/1.1。</li><li><code>$server_addr</code> ： 服务器地址，在完成一次系统调用后可以确定这个值。</li><li><code>$server_name</code> ： 服务器名称。</li><li><code>$server_port</code> ： 请求到达服务器的端口号。</li><li><code>$request_uri</code> ： 包含请求参数的原始URI，不包含主机名，如：”/foo/bar.php?arg=baz”。</li><li><code>$uri</code> ： 不带请求参数的当前URI，$uri不包含主机名，如”/foo/bar.html”。</li><li><code>$document_uri</code> ： 与$uri相同。</li></ul><p>例：<code>http://localhost:88/test1/test2/test.php</code> $host：localhost $server_port：88 $request_uri：<a href="http://localhost:88/test1/test2/test.php" target="_blank" rel="noopener noreferrer">http://localhost:88/test1/test2/test.php<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> $document_uri：/test1/test2/test.php $document_root：/var/www/html $request_filename：/var/www/html/test1/test2/test.php</p><h3 id="_2-3-常用正则" tabindex="-1"><a class="header-anchor" href="#_2-3-常用正则" aria-hidden="true">#</a> 2.3 常用正则</h3><ul><li><code>.</code> ： 匹配除换行符以外的任意字符</li><li><code>?</code> ： 重复0次或1次</li><li><code>+</code> ： 重复1次或更多次</li><li><code>*</code> ： 重复0次或更多次</li><li><code>\d</code> ：匹配数字</li><li><code>^</code> ： 匹配字符串的开始</li><li>` ： 匹配字符串的介绍</li><li><code>{n}</code> ： 重复n次</li><li><code>{n,}</code> ： 重复n次或更多次</li><li><code>[c]</code> ： 匹配单个字符c</li><li><code>[a-z]</code> ： 匹配a-z小写字母的任意一个</li></ul><p>小括号<code>()</code>之间匹配的内容，可以在后面通过<code>$1</code>来引用，<code>$2</code>表示的是前面第二个<code>()</code>里的内容。正则里面容易让人困惑的是<code>\</code>转义特殊字符。</p><h3 id="_2-4-rewrite实例" tabindex="-1"><a class="header-anchor" href="#_2-4-rewrite实例" aria-hidden="true">#</a> 2.4 rewrite实例</h3><p><em>例1</em>：</p><div class="language-nginx ext-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">{</span>

    <span class="token comment"># 定义image日志格式</span>
    <span class="token directive"><span class="token keyword">log_format</span> imagelog <span class="token string">&#39;[<span class="token variable">$time_local]</span> &#39;</span> <span class="token variable">$image_file</span> <span class="token string">&#39; &#39;</span> <span class="token variable">$image_type</span> <span class="token string">&#39; &#39;</span> <span class="token variable">$body_bytes_sent</span> <span class="token string">&#39; &#39;</span> <span class="token variable">$status</span></span><span class="token punctuation">;</span>

    <span class="token comment"># 开启重写日志</span>
    <span class="token directive"><span class="token keyword">rewrite_log</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">root</span> /home/www</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
            <span class="token comment"># 重写规则信息</span>
            <span class="token directive"><span class="token keyword">error_log</span> logs/rewrite.log notice</span><span class="token punctuation">;</span>
            <span class="token comment"># 注意这里要用‘’单引号引起来，避免{}</span>
            <span class="token directive"><span class="token keyword">rewrite</span> <span class="token string">&#39;^/images/([a-z]{2})/([a-z0-9]{5})/(.*)\.(png|jpg|gif)&#39;</span> /data?file=<span class="token variable">$3</span>.<span class="token variable">$4</span></span><span class="token punctuation">;</span>
            <span class="token comment"># 注意不能在上面这条规则后面加上“last”参数，否则下面的set指令不会执行</span>
            <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$image_file</span> <span class="token variable">$3</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$image_type</span> <span class="token variable">$4</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token directive"><span class="token keyword">location</span> /data</span> <span class="token punctuation">{</span>
             <span class="token comment"># 指定针对图片的日志格式，来分析图片类型和大小</span>
             <span class="token directive"><span class="token keyword">access_log</span> logs/images.log mian</span><span class="token punctuation">;</span>
             <span class="token directive"><span class="token keyword">root</span> /data/images</span><span class="token punctuation">;</span>
             <span class="token comment"># 应用前面定义的变量。判断首先文件在不在，不在再判断目录在不在，如果还不在就跳转到最后一个url里</span>
             <span class="token directive"><span class="token keyword">try_files</span> /<span class="token variable">$arg_file</span> /image404.html</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token directive"><span class="token keyword">location</span> = /image404.html</span> <span class="token punctuation">{</span>
            <span class="token comment"># 图片不存在返回特定的信息</span>
            <span class="token directive"><span class="token keyword">return</span> <span class="token number">404</span> <span class="token string">&quot;image not found<span class="token escape entity">\n</span>&quot;</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>对形如<code>/images/ef/uh7b3/test.png</code>的请求，重写到<code>/data?file=test.png</code>，于是匹配到<code>location /data</code>，先看<code>/data/images/test.png</code>文件存不存在，如果存在则正常响应，如果不存在则重写tryfiles到新的image404 location，直接返回404状态码。</p><p><em>例2</em>：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>rewrite ^/images/(.*)_(\d+)x(\d+)\.(png|jpg|gif)$ /resizer/$1.$4?width=$2&amp;height=$3? last;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>对形如<code>/images/bla_500x400.jpg</code>的文件请求，重写到<code>/resizer/bla.jpg?width=500&amp;height=400</code>地址，并会继续尝试匹配location。</p><p><em>例3</em>： 见 <a href="http://seanlook.com/2015/05/28/nginx-ssl" target="_blank" rel="noopener noreferrer">ssl部分页面加密<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> 。</p><p><strong>参考</strong></p><ul><li><a href="http://www.nginx.cn/216.html" target="_blank" rel="noopener noreferrer">http://www.nginx.cn/216.html<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li><li><a href="http://www.ttlsa.com/nginx/nginx-rewriting-rules-guide/" target="_blank" rel="noopener noreferrer">http://www.ttlsa.com/nginx/nginx-rewriting-rules-guide/<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li><li>老僧系列nginx之rewrite规则快速上手</li><li><a href="http://fantefei.blog.51cto.com/2229719/919431" target="_blank" rel="noopener noreferrer">http://fantefei.blog.51cto.com/2229719/919431<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li></ul><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">2021/8/23 上午12:08:33</span></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: zhaody901@126.com">duoli</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.ce6e78a5.js" defer></script><script src="/assets/js/2968.6fb6be6b.js" defer></script><script src="/assets/js/app.21ffca0f.js" defer></script>
  </body>
</html>
