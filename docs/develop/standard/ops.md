# 运维标准化

这里的整理按照服务器/数据库/应用去做整理

## A. 系统

### 系统环境

-   curl 进行更新
-   服务器保持最新, 以保持最新的安全 bug 得以更新

### 系统用户以及登录

-   系统运行用户使用 `普通用户` 来进行运行
-   禁用 root 用户登录, 使用普通用户切权限进行服务器的更新
-   配置用户使用 ssh + private key 进行登录
-   用户登录的 key 以及密钥需要定期更换

### 系统端口以及安全

-   系统登录端口更换, 不使用默认的 22
-   系统防火墙仅仅允许指定的端口来进行访问
-   系统 安装 mysql 客户端来进行客户端访问请求测试

### 系统监控

-   进程以及使用率监控
-   系统的负载的监控
-   系统的硬盘使用率监控
-   系统日志监控

### 运行环境拓扑结构

> 运行环境的拓扑环境的整理以及服务监控

## B.1. 应用 - Nginx

### 访问日志

访问日志的路径是

`/webdata/logs/{project}/access|error.log`, 类似于这种, 如果有多个, 可以通过命名区分

**日志的汇总**

日志的汇总采用的是 Aliyun 的 [ilogtail](https://help.aliyun.com/document_detail/28982.html)

**日志的备份**

因为互联网从业者需要保留至少半年的日志数据, 所以这里的日志数据可以保留 180 天以上

**访问日志的实时分析**

Ali 的日志服务非常完备, 需要进行分析的话, 可以很快进行数据的分析

**日志的存储**

日志存储采用自动存储, 本地最多留存一个月, 保留磁盘的空间大小

### Nginx 连接数问题

连接数影响到了服务器同时在线人数, 如果服务器报 500 的错误, 但是应用层没有收到任何请求, 则应该是连接数的问题

## B.2. 应用 - PHP

### 2.1 错误的邮件提醒

### 2.2 应用的自动化部署

自动化部署
部署之后使用钉钉进行通知

### 2.3 php 的应用升级为 7.4

### 2.4 应用日志

## B.3. 应用 - Supervisor

## B.4. 应用 - Redis

## B.5. 数据库

### 3.1 查询账号

root 账号和查询账号分开
账号区分为

### 3.2 慢查询日志

### 3.3 数据库存储需要扩充

### 3.4 考虑升级为 8.0

### 3.5 数据库的 binlog

-   [x] 数据库 base_backup 自动备份, 清理
-   [x] 数据库慢日志定时发送
-   [ ] 运维集成钉钉, 对数据进行推送(可以写到运维平台)

### 数据库备份与恢复

### 数据库主从

## C. 代码部分

1. 环境的自动配置
2. 自动化部署
    1. 代码支持自动化拉取[公钥和私钥来进行更新/Aliyun]
3. 前端的自动化打包以及部署还有刷新 CDN

## 4. Aliyun

## E.项目

1. 项目监控, 通过日志来进行监控
2. 队列
3. 服务器性能
4. 数据库慢日志

### 阿里云账号细粒度控制

使用子用户账户来访问应用, 不使用全局的 AK, 全局 AK, 风险太大, 无法控制系统的安全性

安全
配置防火墙开放指定端口
登陆：为每个人分配一个普通用户，最小化权限。
跳板机：先登录跳板机，再用分配账户登陆（不适用公司环境，加重登陆服务器的复杂程度）
Ssh 端口号更改
删除无用的用户和组
关掉不用的服务

监控
服务器的运行状态监控：启停
服务器的硬件状态：cpu、内存、网络、磁盘
服务的状态：并发状态、连接状态、启停状态、各项指数
重要配置文件：密码文件、配置文件、代码目录
日志：系统日志和应用日志：
错误日志报错告警、访问日志（http：404、mysql：连接等）
告警：设置监控阈值告警

文档管理：
公司搭建自己的文档管理系统或找网上文件管理系统
各类文档整理：产品、开发、测试、运维、ui 等技术性文档
问题文档：包括产品、开发、测试、运维、ui 等提出的问题或工作中遇到的问题进行整理
Bug 文档：仅限于开发，遇到 bug 及时整理保存，以 bug 报错为标题。
文档开始会不多，但慢慢去积累，工作中遇到问题，先思考，再去查文档，再去提问或谷歌，可以提高解决 bug 的效率，尤其是新到的员工。

部署
21 服务器代码部署：
自动化更新
线上代码部署：
台代码同时部署
台代码同时回滚
应用部署：
自动化部署：写好脚本多台同时部署
部署失败恢复

服务器持续交付
阿里的镜像服务：写好与生产环境相同的镜像，利用阿里的镜像服务快速交付多台临时服务器

日志
利用监控监控日志报错并告警
如果机器充足可以搭建日志分析系统，这样做日志分析的比较全面，因为日志分析对计算要求很高，本地分析一般情况在报错后分析，分析的并不是特别准确。
日志备份：web 日志备份、mysql 相关日志
自动化
Ansible 工具
代码部署
应用部署

备份
日志备份
数据库备份
重要配置文件备份

架构
现在每台服务器配置的服务比较多，显得比较臃肿，而负载都不高，建议把每台服务器的配置降低，数量增加，进行服务分层，把数据、应用、缓存、代理、分别部署在不同的服务器上，是较高更加条理，无论从管理还是扩建都会更加清晰
例如，分发可以用 2 核 4g 或 3 核 6g，后端服务器可以用 4 核 8g，数据库可以用 8 和 16g，
这样的可以增加服务器的数量来把每个项目做负载均衡，这样比高配置性能更好，还比较划算，一台服务器出问题影响比较小。
处理单点故障，及基本故障自动恢复等

可视化
代码部署可视化：利用 web 界面部署代码、回滚代码
服务部署
监控
在线人数（并发）

告警
安全告警
服务停止告警
硬件阈值告警
日志大量报错告警

## E2.数据管理方式

1. 本地数据库每日备份一次
2. 线上数据库使用策略等方式, 每日备份一次
3. 数据库采用独立服务器
4. 软件服务器和数据库服务器分开请求, 不得走一个服务器, 便于数据库独立分开

## 补充(未整理)

### 1. 日志分析

-   数据库慢日志[每日]
    每日发送一次, 交由开发人员进行处理
-   用户请求数量
    -   每日报表 [文字/图片(柱状图/折线图)]
    -   每周报表 [峰值量/总访问量]
    -   每月报表 [峰值量/总访问量]
    -   时间段报表 [3 个月/6 个月/1 年][峰值量/总访问量]
-   用户请求网址慢查询[每日]
    列出最近 10 个用户请求最慢的地址, 其中包含
    -   地址
    -   访问时长
    -   访问数量
-   用户请求网址数量最多的查询[每日] 20 个
    列出用户请求地址最多的网址, 包含内容
    -   网址
    -   请求数量
-   用户访问 IP 最多的列表[每日] 20 个
    -   IP 地址
    -   IP 地址访问次数
    -   此 IP 地址最多的访问页面
-   错误日志分析[服务器日志]
    -   死链接, 包含但是不限于 [404, 500..]
    -   错误日志
    -   包含[地址, 错误码, 访问次数]
-   代码运行环境错误日志
    -   PHP 日志
    -   centrifuge
    -   supervisor
    -   redis 日志
-   应用日志[代码运行目录下日志]
    -   错误类型, 这里我们需要约定下日志的报错格式.

### 2. 备份机制

-   数据库备份[!!!需要完善]
-   日志备份[!!!需要完善]

### 3. 安全机制

-   设立堡垒机
    设立堡垒机之前需要确认的内容
    -   数据库可以通过堡垒机访问
-   监控堡垒机服务器用户的操作情况
-   异常 IP 禁用机制
-   告警机制

### 4. 服务器优化配置

-   服务器优化配置方案

### 5. 数据库

-   备份
-   恢复
-   MHA (高可用)

![](https://file.wulicode.com/note/2021/10-22/10-13-39017.png)
